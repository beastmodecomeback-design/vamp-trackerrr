<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VAMP TRACKER</title>
  <style>
    :root{
      --bg:#070812;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --good:#22c55e;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(139,92,246,.25), transparent 60%),
        radial-gradient(700px 400px at 80% 20%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(600px 500px at 50% 90%, rgba(99,102,241,.18), transparent 60%),
        linear-gradient(180deg, #050611 0%, #070812 60%, #050611 100%);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* stars */
    .stars::before, .stars::after{
      content:"";
      position:fixed; inset:-200px;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.7) 50%, transparent 51%),
        radial-gradient(1px 1px at 120px 160px, rgba(255,255,255,.55) 50%, transparent 51%),
        radial-gradient(1px 1px at 220px 80px, rgba(255,255,255,.45) 50%, transparent 51%),
        radial-gradient(2px 2px at 340px 220px, rgba(255,255,255,.65) 50%, transparent 51%),
        radial-gradient(1px 1px at 420px 140px, rgba(255,255,255,.35) 50%, transparent 51%);
      background-size: 520px 260px;
      opacity:.30;
      pointer-events:none;
      filter: blur(.15px);
      animation: drift 18s linear infinite;
    }
    .stars::after{
      opacity:.18;
      transform: scale(1.6);
      animation-duration: 32s;
    }
    @keyframes drift{
      from{transform: translateY(0)}
      to{transform: translateY(220px)}
    }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(5,6,17,.55);
      border-bottom:1px solid var(--stroke);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.6px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 18px rgba(139,92,246,.55);
    }
    .right{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .liveDot{
      width:8px;height:8px;border-radius:99px;background:var(--good);
      box-shadow:0 0 14px rgba(34,197,94,.7);
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      font-weight:650;
      transition:.15s;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.07)}
    .btn.primary{
      border:none;
      background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.85));
      box-shadow: 0 12px 30px rgba(139,92,246,.25);
    }

    .layout{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
    }

    .panel{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .panelHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .small{
      font-size:12px; color:var(--muted);
    }

    .watchlist{
      padding:12px 14px 14px;
    }
    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      outline:none;
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:12px;
      line-height:1.35;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size:12px;
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .feedWrap{
      padding:12px 12px 14px;
    }

    .tweet{
      display:flex;
      gap:12px;
      padding:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
      border-radius:16px;
      margin-bottom:12px;
      position:relative;
      overflow:hidden;
    }
    .tweet::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(400px 160px at 0% 0%, rgba(139,92,246,.20), transparent 60%);
      pointer-events:none;
    }

    .pfp{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      object-fit:cover;
      flex:0 0 auto;
    }
    .tBody{flex:1; min-width:0}
    .tTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .who{
      display:flex; align-items:center; gap:8px;
      min-width:0;
    }
    .name{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }
    .handle{color:var(--muted); font-size:12px}
    .time{color:var(--muted); font-size:12px; white-space:nowrap}
    .text{
      font-size:14px;
      line-height:1.45;
      color:rgba(255,255,255,.90);
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .media{
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .media img{
      width:100%;
      display:block;
      max-height:420px;
      object-fit:cover;
    }
    .metrics{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .chip{
      padding:6px 8px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:999px;
    }
    .empty{
      padding:24px;
      text-align:center;
      color:var(--muted);
    }
  </style>
</head>

<body class="stars">
  <header>
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>VAMP TRACKER</span>
      </div>
      <div class="right">
        <div class="pill"><span class="liveDot"></span> LIVE <span id="liveCount">0</span></div>
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn primary" id="autoBtn">Auto: ON</button>
      </div>
    </div>
  </header>

  <main class="layout">
    <section class="panel">
      <div class="panelHeader">
        <h3>Watchlist</h3>
        <span class="small">one per line</span>
      </div>
      <div class="watchlist">
        <textarea id="watchlist"></textarea>
        <div class="hint">
          Paste usernames like <b>ansem</b> (no @ needed).<br/>
          This UI is clean. Your function polls X and returns tweets + profile pics + images.
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;">
          <button class="btn primary" id="saveBtn" style="flex:1;">Save Watchlist</button>
          <button class="btn" id="demoBtn" style="flex:1;">Demo Mode</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panelHeader">
        <h3>Live Feed</h3>
        <span class="small" id="status">Waiting‚Ä¶</span>
      </div>
      <div class="feedWrap" id="feed">
        <div class="empty">Loading‚Ä¶</div>
      </div>
    </section>
  </main>

  <script>
    const FEED = document.getElementById("feed");
    const STATUS = document.getElementById("status");
    const LIVECOUNT = document.getElementById("liveCount");
    const watchlistEl = document.getElementById("watchlist");

    const DEFAULT = [
      "cz_binance","elonmusk","solana","WatcherGuru","Cointelegraph","WhaleAlert","ansem","threadguy","0xSisyphus"
    ];

    let auto = true;
    let timer = null;
    let demoMode = false;

    function loadWatchlist(){
      const saved = localStorage.getItem("vamp_watchlist");
      const list = saved ? saved.split("\n").map(s=>s.trim()).filter(Boolean) : DEFAULT;
      watchlistEl.value = list.join("\n");
      return list;
    }

    function saveWatchlist(){
      localStorage.setItem("vamp_watchlist", watchlistEl.value.trim());
    }

    function timeAgo(iso){
      const t = new Date(iso).getTime();
      const s = Math.floor((Date.now()-t)/1000);
      if (s < 60) return s + "s";
      const m = Math.floor(s/60);
      if (m < 60) return m + "m";
      const h = Math.floor(m/60);
      if (h < 24) return h + "h";
      const d = Math.floor(h/24);
      return d + "d";
    }

    function linkify(text){
      // basic linkify (urls + @mentions)
      return text
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#9ae6ff;text-decoration:none;">$1</a>')
        .replace(/@([a-zA-Z0-9_]+)/g, '<span style="color:#c4b5fd">@\$1</span>');
    }

    function renderTweets(payload){
      const tweets = payload?.data || [];
      const includes = payload?.includes || {};
      const users = includes.users || [];
      const media = includes.media || [];

      const userMap = new Map(users.map(u => [u.id, u]));
      const mediaMap = new Map(media.map(m => [m.media_key, m]));

      LIVECOUNT.textContent = String(tweets.length);

      if (!tweets.length){
        FEED.innerHTML = `<div class="empty">No tweets yet. Hit Refresh or wait.</div>`;
        return;
      }

      FEED.innerHTML = tweets.map(t => {
        const u = userMap.get(t.author_id) || {};
        const pfp = (u.profile_image_url || "").replace("_normal","_200x200");
        const name = u.name || "Unknown";
        const handle = u.username ? "@"+u.username : "@unknown";
        const when = t.created_at ? timeAgo(t.created_at) : "";

        // media (images/video preview)
        let mediaHtml = "";
        const keys = t.attachments?.media_keys || [];
        if (keys.length){
          // show first media for now
          const m = mediaMap.get(keys[0]);
          const img = m?.url || m?.preview_image_url;
          if (img){
            mediaHtml = `<div class="media"><img src="${img}" alt="media" loading="lazy"></div>`;
          }
        }

        const metrics = t.public_metrics || {};
        const rt = metrics.retweet_count ?? 0;
        const rp = metrics.reply_count ?? 0;
        const lk = metrics.like_count ?? 0;
        const im = metrics.impression_count ?? 0;

        const text = linkify((t.text || "").trim());

        return `
          <div class="tweet">
            <img class="pfp" src="${pfp}" alt="pfp" onerror="this.style.display='none'">
            <div class="tBody">
              <div class="tTop">
                <div class="who">
                  <div class="name">${name}</div>
                  <div class="handle">${handle}</div>
                </div>
                <div class="time">${when}</div>
              </div>
              <div class="text">${text}</div>
              ${mediaHtml}
              <div class="metrics">
                <span class="chip">‚ù§Ô∏è ${lk}</span>
                <span class="chip">üí¨ ${rp}</span>
                <span class="chip">üîÅ ${rt}</span>
                <span class="chip">üëÄ ${im}</span>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function fetchFeed(){
      try{
        STATUS.textContent = demoMode ? "Demo mode" : "Fetching‚Ä¶";
        const res = await fetch("/.netlify/functions/poll", { cache: "no-store" });
        const data = await res.json();

        if (data?.error){
          FEED.innerHTML = `<div class="empty">Function error: ${data.error}</div>`;
          STATUS.textContent = "Error";
          return;
        }

        renderTweets(data);
        STATUS.textContent = demoMode ? "Demo mode" : "Live updated";
      } catch(e){
        FEED.innerHTML = `<div class="empty">Failed to load. ${e.message}</div>`;
        STATUS.textContent = "Offline";
      }
    }

    function startAuto(){
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        if (auto && !demoMode) fetchFeed();
      }, 15000); // 15 sec
    }

    // Buttons
    document.getElementById("refreshBtn").onclick = () => fetchFeed();
    document.getElementById("saveBtn").onclick = () => {
      saveWatchlist();
      alert("Saved. (Watchlist filtering is next step.)");
    };

    document.getElementById("autoBtn").onclick = (e) => {
      auto = !auto;
      e.target.textContent = "Auto: " + (auto ? "ON" : "OFF");
      e.target.classList.toggle("primary", auto);
      if (auto && !demoMode) fetchFeed();
    };

    document.getElementById("demoBtn").onclick = () => {
      demoMode = !demoMode;
      if (demoMode){
        STATUS.textContent = "Demo mode";
        LIVECOUNT.textContent = "3";
        FEED.innerHTML = `
          <div class="tweet">
            <img class="pfp" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png">
            <div class="tBody">
              <div class="tTop">
                <div class="who">
                  <div class="name">Demo Whale</div>
                  <div class="handle">@demowhale</div>
                </div>
                <div class="time">12s</div>
              </div>
              <div class="text">pepe meta heating up üî•</div>
              <div class="metrics">
                <span class="chip">‚ù§Ô∏è 28</span><span class="chip">üí¨ 21</span><span class="chip">üîÅ 4</span><span class="chip">üëÄ 1934</span>
              </div>
            </div>
          </div>
          <div class="tweet">
            <img class="pfp" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png">
            <div class="tBody">
              <div class="tTop">
                <div class="who">
                  <div class="name">Demo Ansem</div>
                  <div class="handle">@ansem</div>
                </div>
                <div class="time">1m</div>
              </div>
              <div class="text">CA: new deploy just dropped</div>
              <div class="metrics">
                <span class="chip">‚ù§Ô∏è 9</span><span class="chip">üí¨ 1</span><span class="chip">üîÅ 1</span><span class="chip">üëÄ 479</span>
              </div>
            </div>
          </div>
          <div class="tweet">
            <img class="pfp" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png">
            <div class="tBody">
              <div class="tTop">
                <div class="who">
                  <div class="name">Demo Sol</div>
                  <div class="handle">@solana</div>
                </div>
                <div class="time">3m</div>
              </div>
              <div class="text">sol trenches active üßõ</div>
              <div class="metrics">
                <span class="chip">‚ù§Ô∏è 11</span><span class="chip">üí¨ 2</span><span class="chip">üîÅ 0</span><span class="chip">üëÄ 485</span>
              </div>
            </div>
          </div>
        `;
      } else {
        STATUS.textContent = "Live mode";
        fetchFeed();
      }
    };

    // init
    loadWatchlist();
    fetchFeed();
    startAuto();
  </script>
</body>
</html>
